DROP TABLE IF EXISTS SOURCE_TABLE_PACK;

CREATE TABLE SOURCE_TABLE_PACK AS
SELECT ENR,
	'1' AS wsstf,
	ZNR,
	REGNR,
	KENNZ,
	ZNRION,
	AM,
	RUH,
	regexp_replace(DFO, ' und .*$', '', 'g') AS DFO,
	BDZUL,
	SZ,
	ANTR,
	SANTR,
	IND,
	LNRTEILO1,
	BM1,
	WSSTF1_1 AS INGREDIENT1,
	WSSTF1_2 AS INGREDIENT2,
	WSSTF1_3 AS INGREDIENT3,
	WSSTF1_4 AS INGREDIENT4,
	WSSTF1_5 AS INGREDIENT5,
	WSSTF1_6 AS INGREDIENT6,
	WSSTF1_7 AS INGREDIENT7,
	WSSTF1_8 AS INGREDIENT8,
	WSSTF1_9 AS INGREDIENT9,
	WSSTF1_10 AS INGREDIENT10,
	WSSTF1_11 AS INGREDIENT11,
	WSSTF1_12 AS INGREDIENT12,
	WSSTF1_13 AS INGREDIENT13,
	WSSTF1_14 AS INGREDIENT14,
	WSSTF1_15 AS INGREDIENT15,
	WSSTF1_16 AS INGREDIENT16,
	WSSTF1_17 AS INGREDIENT17,
	WSSTF1_18 AS INGREDIENT18,
	WSSTF1_19 AS INGREDIENT19,
	WSSTF1_20 AS INGREDIENT20,
	WSSTF1_21 AS INGREDIENT21,
	WSSTF1_22 AS INGREDIENT22,
	WSSTF1_23 AS INGREDIENT23,
	WSSTF1_24 AS INGREDIENT24,
	WSSTF1_25 AS INGREDIENT25,
	WSSTF1_26 AS INGREDIENT26,
	WSSTF1_27 AS INGREDIENT27,
	WSSTF1_28 AS INGREDIENT28,
	WSSTF1_29 AS INGREDIENT29,
	WSSTF1_30 AS INGREDIENT30,
	ADRANTL,
	PAGR,
	TPACK_1,
	TPACK_2,
	TPACK_3,
	TPACK_4,
	TPACK_5,
	TPACK_6,
	TPACK_7,
	TPACK_8,
	TPACK_9,
	TPACK_10,
	TPACK_11,
	TPACK_12,
	TPACK_13,
	TPACK_14,
	TPACK_15,
	TPACK_16,
	TPACK_17,
	TPACK_18,
	TPACK_19,
	TPACK_20,
	TPACK_21,
	TPACK_22,
	TPACK_23,
	TPACK_24,
	TPACK_25,
	TPACK_26,
	TPACK_27,
	TPACK_28,
	TPACK_29,
	TPACK_30,
	TPACK_31,
	TPACK_32,
	TPACK_33,
	TPACK_34,
	TPACK_35,
	TPACK_36,
	TPACK_37,
	TPACK_38,
	TPACK_39,
	TPACK_40,
	TPACK_41,
	TPACK_42,
	TPACK_43,
	TPACK_44,
	TPACK_45,
	TPACK_46,
	TPACK_47,
	TPACK_48,
	TPACK_49,
	TPACK_50,
	TPACK_51,
	TPACK_52,
	TPACK_53,
	TPACK_54,
	TPACK_55,
	TPACK_56,
	TPACK_57,
	TPACK_58,
	TPACK_59,
	TPACK_60,
	TPACK_61,
	TPACK_62,
	TPACK_63,
	TPACK_64,
	TPACK_65,
	TPACK_66,
	TPACK_67,
	TPACK_68,
	TPACK_69,
	TPACK_70,
	INVD,
	DOMAIN_ID,
	ATC_CODE,
	BRAND_NAME
FROM SOURCE_TABLE
WHERE WSSTF2_1 IS NOT NULL
	--and DFO not in ('Emulsion zur Infusion', 'Pulver und%', 'Injektionsloesung', 'Pulver mit%', 'Trockensubstanz', 'Injektionsloesung', 'Lyophilisat und%') 
	--or BM2  like '%Doppelkammerbeutel%' 
	AND DOMAIN_ID = 'Drug'

UNION ALL

SELECT ENR,
	'2' AS wsstf,
	ZNR,
	REGNR,
	KENNZ,
	ZNRION,
	AM,
	RUH,
	regexp_replace(DFO, '^.* und ', '', 'g') AS DFO,
	BDZUL,
	SZ,
	ANTR,
	SANTR,
	IND,
	LNRTEILO1,
	BM1,
	WSSTF2_1 AS INGREDIENT1,
	WSSTF2_2 AS INGREDIENT2,
	WSSTF2_3 AS INGREDIENT3,
	WSSTF2_4 AS INGREDIENT4,
	WSSTF2_5 AS INGREDIENT5,
	WSSTF2_6 AS INGREDIENT6,
	WSSTF2_7 AS INGREDIENT7,
	WSSTF2_8 AS INGREDIENT8,
	WSSTF2_9 AS INGREDIENT9,
	WSSTF2_10 AS INGREDIENT10,
	WSSTF2_11 AS INGREDIENT11,
	WSSTF2_12 AS INGREDIENT12,
	WSSTF2_13 AS INGREDIENT13,
	WSSTF2_14 AS INGREDIENT14,
	WSSTF2_15 AS INGREDIENT15,
	WSSTF2_16 AS INGREDIENT16,
	WSSTF2_17 AS INGREDIENT17,
	WSSTF2_18 AS INGREDIENT18,
	WSSTF2_19 AS INGREDIENT19,
	WSSTF2_20 AS INGREDIENT20,
	WSSTF2_21 AS INGREDIENT21,
	WSSTF2_22 AS INGREDIENT22,
	NULL AS INGREDIENT23,
	NULL AS INGREDIENT24,
	NULL AS INGREDIENT25,
	NULL AS INGREDIENT26,
	NULL AS INGREDIENT27,
	NULL AS INGREDIENT28,
	NULL AS INGREDIENT29,
	NULL AS INGREDIENT30,
	ADRANTL,
	PAGR,
	TPACK_1,
	TPACK_2,
	TPACK_3,
	TPACK_4,
	TPACK_5,
	TPACK_6,
	TPACK_7,
	TPACK_8,
	TPACK_9,
	TPACK_10,
	TPACK_11,
	TPACK_12,
	TPACK_13,
	TPACK_14,
	TPACK_15,
	TPACK_16,
	TPACK_17,
	TPACK_18,
	TPACK_19,
	TPACK_20,
	TPACK_21,
	TPACK_22,
	TPACK_23,
	TPACK_24,
	TPACK_25,
	TPACK_26,
	TPACK_27,
	TPACK_28,
	TPACK_29,
	TPACK_30,
	TPACK_31,
	TPACK_32,
	TPACK_33,
	TPACK_34,
	TPACK_35,
	TPACK_36,
	TPACK_37,
	TPACK_38,
	TPACK_39,
	TPACK_40,
	TPACK_41,
	TPACK_42,
	TPACK_43,
	TPACK_44,
	TPACK_45,
	TPACK_46,
	TPACK_47,
	TPACK_48,
	TPACK_49,
	TPACK_50,
	TPACK_51,
	TPACK_52,
	TPACK_53,
	TPACK_54,
	TPACK_55,
	TPACK_56,
	TPACK_57,
	TPACK_58,
	TPACK_59,
	TPACK_60,
	TPACK_61,
	TPACK_62,
	TPACK_63,
	TPACK_64,
	TPACK_65,
	TPACK_66,
	TPACK_67,
	TPACK_68,
	TPACK_69,
	TPACK_70,
	INVD,
	DOMAIN_ID,
	ATC_CODE,
	BRAND_NAME
FROM SOURCE_TABLE
WHERE WSSTF2_1 IS NOT NULL
	--and DFO not in ('Emulsion zur Infusion', 'Pulver und%', 'Injektionsloesung', 'Pulver mit%', 'Trockensubstanz', 'Injektionsloesung', 'Lyophilisat und%') 
	--or BM2  like '%Doppelkammerbeutel%' 
	AND DOMAIN_ID = 'Drug'

UNION ALL

SELECT ENR,
	'3' AS wsstf,
	ZNR,
	REGNR,
	KENNZ,
	ZNRION,
	AM,
	RUH,
	regexp_replace(DFO, '^.* und ', '', 'g') AS DFO,
	BDZUL,
	SZ,
	ANTR,
	SANTR,
	IND,
	LNRTEILO1,
	BM1,
	WSSTF3_1 AS INGREDIENT1,
	WSSTF3_2 AS INGREDIENT2,
	WSSTF3_3 AS INGREDIENT3,
	WSSTF3_4 AS INGREDIENT4,
	WSSTF3_5 AS INGREDIENT5,
	WSSTF3_6 AS INGREDIENT6,
	WSSTF3_7 AS INGREDIENT7,
	WSSTF3_8 AS INGREDIENT8,
	WSSTF3_9 AS INGREDIENT9,
	WSSTF3_10 AS INGREDIENT10,
	WSSTF3_11 AS INGREDIENT11,
	WSSTF3_12 AS INGREDIENT12,
	WSSTF3_13 AS INGREDIENT13,
	WSSTF3_14 AS INGREDIENT14,
	WSSTF3_15 AS INGREDIENT15,
	WSSTF3_16 AS INGREDIENT16,
	WSSTF3_17 AS INGREDIENT17,
	WSSTF3_18 AS INGREDIENT18,
	WSSTF3_19 AS INGREDIENT19,
	WSSTF3_20 AS INGREDIENT20,
	WSSTF3_21 AS INGREDIENT21,
	WSSTF3_22 AS INGREDIENT22,
	WSSTF3_23 AS INGREDIENT23,
	NULL AS INGREDIENT24,
	NULL AS INGREDIENT25,
	NULL AS INGREDIENT26,
	NULL AS INGREDIENT27,
	NULL AS INGREDIENT28,
	NULL AS INGREDIENT29,
	NULL AS INGREDIENT30,
	ADRANTL,
	PAGR,
	TPACK_1,
	TPACK_2,
	TPACK_3,
	TPACK_4,
	TPACK_5,
	TPACK_6,
	TPACK_7,
	TPACK_8,
	TPACK_9,
	TPACK_10,
	TPACK_11,
	TPACK_12,
	TPACK_13,
	TPACK_14,
	TPACK_15,
	TPACK_16,
	TPACK_17,
	TPACK_18,
	TPACK_19,
	TPACK_20,
	TPACK_21,
	TPACK_22,
	TPACK_23,
	TPACK_24,
	TPACK_25,
	TPACK_26,
	TPACK_27,
	TPACK_28,
	TPACK_29,
	TPACK_30,
	TPACK_31,
	TPACK_32,
	TPACK_33,
	TPACK_34,
	TPACK_35,
	TPACK_36,
	TPACK_37,
	TPACK_38,
	TPACK_39,
	TPACK_40,
	TPACK_41,
	TPACK_42,
	TPACK_43,
	TPACK_44,
	TPACK_45,
	TPACK_46,
	TPACK_47,
	TPACK_48,
	TPACK_49,
	TPACK_50,
	TPACK_51,
	TPACK_52,
	TPACK_53,
	TPACK_54,
	TPACK_55,
	TPACK_56,
	TPACK_57,
	TPACK_58,
	TPACK_59,
	TPACK_60,
	TPACK_61,
	TPACK_62,
	TPACK_63,
	TPACK_64,
	TPACK_65,
	TPACK_66,
	TPACK_67,
	TPACK_68,
	TPACK_69,
	TPACK_70,
	INVD,
	DOMAIN_ID,
	ATC_CODE,
	BRAND_NAME
FROM SOURCE_TABLE
WHERE WSSTF2_1 IS NOT NULL
	--and DFO not in ('Emulsion zur Infusion', 'Pulver und%', 'Injektionsloesung', 'Pulver mit%', 'Trockensubstanz', 'Injektionsloesung', 'Lyophilisat und%') 
	--or BM2  like '%Doppelkammerbeutel%' 
	AND DOMAIN_ID = 'Drug'

UNION ALL

SELECT ENR,
	'4' AS wsstf,
	ZNR,
	REGNR,
	KENNZ,
	ZNRION,
	AM,
	RUH,
	regexp_replace(DFO, '^.* und ', '', 'g') AS DFO,
	BDZUL,
	SZ,
	ANTR,
	SANTR,
	IND,
	LNRTEILO1,
	BM1,
	WSSTF4_1 AS INGREDIENT1,
	WSSTF4_2 AS INGREDIENT2,
	WSSTF4_3 AS INGREDIENT3,
	WSSTF4_4 AS INGREDIENT4,
	WSSTF4_5 AS INGREDIENT5,
	WSSTF4_6 AS INGREDIENT6,
	WSSTF4_7 AS INGREDIENT7,
	WSSTF4_8 AS INGREDIENT8,
	WSSTF4_9 AS INGREDIENT9,
	WSSTF4_10 AS INGREDIENT10,
	WSSTF4_11 AS INGREDIENT11,
	WSSTF4_12 AS INGREDIENT12,
	WSSTF4_13 AS INGREDIENT13,
	WSSTF4_14 AS INGREDIENT14,
	WSSTF4_15 AS INGREDIENT15,
	WSSTF4_16 AS INGREDIENT16,
	WSSTF4_17 AS INGREDIENT17,
	WSSTF4_18 AS INGREDIENT18,
	WSSTF4_19 AS INGREDIENT19,
	WSSTF4_20 AS INGREDIENT20,
	WSSTF4_21 AS INGREDIENT21,
	WSSTF4_22 AS INGREDIENT22,
	WSSTF4_23 AS INGREDIENT23,
	WSSTF4_24 AS INGREDIENT24,
	WSSTF4_25 AS INGREDIENT25,
	NULL AS INGREDIENT26,
	NULL AS INGREDIENT27,
	NULL AS INGREDIENT28,
	NULL AS INGREDIENT29,
	NULL AS INGREDIENT30,
	ADRANTL,
	PAGR,
	TPACK_1,
	TPACK_2,
	TPACK_3,
	TPACK_4,
	TPACK_5,
	TPACK_6,
	TPACK_7,
	TPACK_8,
	TPACK_9,
	TPACK_10,
	TPACK_11,
	TPACK_12,
	TPACK_13,
	TPACK_14,
	TPACK_15,
	TPACK_16,
	TPACK_17,
	TPACK_18,
	TPACK_19,
	TPACK_20,
	TPACK_21,
	TPACK_22,
	TPACK_23,
	TPACK_24,
	TPACK_25,
	TPACK_26,
	TPACK_27,
	TPACK_28,
	TPACK_29,
	TPACK_30,
	TPACK_31,
	TPACK_32,
	TPACK_33,
	TPACK_34,
	TPACK_35,
	TPACK_36,
	TPACK_37,
	TPACK_38,
	TPACK_39,
	TPACK_40,
	TPACK_41,
	TPACK_42,
	TPACK_43,
	TPACK_44,
	TPACK_45,
	TPACK_46,
	TPACK_47,
	TPACK_48,
	TPACK_49,
	TPACK_50,
	TPACK_51,
	TPACK_52,
	TPACK_53,
	TPACK_54,
	TPACK_55,
	TPACK_56,
	TPACK_57,
	TPACK_58,
	TPACK_59,
	TPACK_60,
	TPACK_61,
	TPACK_62,
	TPACK_63,
	TPACK_64,
	TPACK_65,
	TPACK_66,
	TPACK_67,
	TPACK_68,
	TPACK_69,
	TPACK_70,
	INVD,
	DOMAIN_ID,
	ATC_CODE,
	BRAND_NAME
FROM SOURCE_TABLE
WHERE WSSTF2_1 IS NOT NULL
	--and DFO not in ('Emulsion zur Infusion', 'Pulver und%', 'Injektionsloesung', 'Pulver mit%', 'Trockensubstanz', 'Injektionsloesung', 'Lyophilisat und%') 
	--or BM2 like '%Doppelkammerbeutel%'
	AND DOMAIN_ID = 'Drug'

UNION ALL

SELECT ENR,
	'5' AS wsstf,
	ZNR,
	REGNR,
	KENNZ,
	ZNRION,
	AM,
	RUH,
	regexp_replace(DFO, '^.* und ', '', 'g') AS DFO,
	BDZUL,
	SZ,
	ANTR,
	SANTR,
	IND,
	LNRTEILO1,
	BM1,
	WSSTF5_1 AS INGREDIENT1,
	WSSTF5_2 AS INGREDIENT2,
	NULL AS INGREDIENT3,
	NULL AS INGREDIENT4,
	NULL AS INGREDIENT5,
	NULL AS INGREDIENT6,
	NULL AS INGREDIENT7,
	NULL AS INGREDIENT8,
	NULL AS INGREDIENT9,
	NULL AS INGREDIENT10,
	NULL AS INGREDIENT11,
	NULL AS INGREDIENT12,
	NULL AS INGREDIENT13,
	NULL AS INGREDIENT14,
	NULL AS INGREDIENT15,
	NULL AS INGREDIENT16,
	NULL AS INGREDIENT17,
	NULL AS INGREDIENT18,
	NULL AS INGREDIENT19,
	NULL AS INGREDIENT20,
	NULL AS INGREDIENT21,
	NULL AS INGREDIENT22,
	NULL AS INGREDIENT23,
	NULL AS INGREDIENT24,
	NULL AS INGREDIENT25,
	NULL AS INGREDIENT26,
	NULL AS INGREDIENT27,
	NULL AS INGREDIENT28,
	NULL AS INGREDIENT29,
	NULL AS INGREDIENT30,
	ADRANTL,
	PAGR,
	TPACK_1,
	TPACK_2,
	TPACK_3,
	TPACK_4,
	TPACK_5,
	TPACK_6,
	TPACK_7,
	TPACK_8,
	TPACK_9,
	TPACK_10,
	TPACK_11,
	TPACK_12,
	TPACK_13,
	TPACK_14,
	TPACK_15,
	TPACK_16,
	TPACK_17,
	TPACK_18,
	TPACK_19,
	TPACK_20,
	TPACK_21,
	TPACK_22,
	TPACK_23,
	TPACK_24,
	TPACK_25,
	TPACK_26,
	TPACK_27,
	TPACK_28,
	TPACK_29,
	TPACK_30,
	TPACK_31,
	TPACK_32,
	TPACK_33,
	TPACK_34,
	TPACK_35,
	TPACK_36,
	TPACK_37,
	TPACK_38,
	TPACK_39,
	TPACK_40,
	TPACK_41,
	TPACK_42,
	TPACK_43,
	TPACK_44,
	TPACK_45,
	TPACK_46,
	TPACK_47,
	TPACK_48,
	TPACK_49,
	TPACK_50,
	TPACK_51,
	TPACK_52,
	TPACK_53,
	TPACK_54,
	TPACK_55,
	TPACK_56,
	TPACK_57,
	TPACK_58,
	TPACK_59,
	TPACK_60,
	TPACK_61,
	TPACK_62,
	TPACK_63,
	TPACK_64,
	TPACK_65,
	TPACK_66,
	TPACK_67,
	TPACK_68,
	TPACK_69,
	TPACK_70,
	INVD,
	DOMAIN_ID,
	ATC_CODE,
	BRAND_NAME
FROM SOURCE_TABLE
WHERE WSSTF2_1 IS NOT NULL
	--and DFO not in ('Emulsion zur Infusion', 'Pulver und%', 'Injektionsloesung', 'Pulver mit%', 'Trockensubstanz', 'Injektionsloesung', 'Lyophilisat und%') 
	--or BM2 like '%Doppelkammerbeutel%' 
	AND DOMAIN_ID = 'Drug';

DELETE
FROM SOURCE_TABLE_PACK
WHERE INGREDIENT1 IS NULL
	AND INGREDIENT2 IS NULL
	AND INGREDIENT3 IS NULL
	AND INGREDIENT4 IS NULL
	AND INGREDIENT5 IS NULL
	AND INGREDIENT6 IS NULL
	AND INGREDIENT7 IS NULL
	AND INGREDIENT8 IS NULL
	AND INGREDIENT9 IS NULL
	AND INGREDIENT10 IS NULL
	AND INGREDIENT11 IS NULL
	AND INGREDIENT12 IS NULL
	AND INGREDIENT13 IS NULL
	AND INGREDIENT14 IS NULL
	AND INGREDIENT15 IS NULL
	AND INGREDIENT16 IS NULL
	AND INGREDIENT17 IS NULL
	AND INGREDIENT18 IS NULL
	AND INGREDIENT19 IS NULL
	AND INGREDIENT20 IS NULL
	AND INGREDIENT21 IS NULL
	AND INGREDIENT22 IS NULL
	AND INGREDIENT23 IS NULL
	AND INGREDIENT24 IS NULL
	AND INGREDIENT25 IS NULL
	AND INGREDIENT26 IS NULL
	AND INGREDIENT27 IS NULL
	AND INGREDIENT28 IS NULL
	AND INGREDIENT29 IS NULL
	AND INGREDIENT30 IS NULL;

ALTER TABLE SOURCE_TABLE_PACK ADD DRUG_CODE VARCHAR(1023);

-- Need access to right sequence
UPDATE SOURCE_TABLE_PACK
SET DRUG_CODE = 'OMOP' || nextval('new_voc');